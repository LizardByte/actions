---
name: CI Tests
permissions:
  contents: write  # write is required for release_setup

on:
  pull_request:
    branches:
      - master
    types:
      - opened
      - synchronize
      - reopened
  push:
    branches:
      - master
  workflow_dispatch:

concurrency:
  group: "${{ github.workflow }}-${{ github.ref }}"
  cancel-in-progress: true

jobs:
  tests:
    runs-on: ${{ matrix.runner }}
    env:
      INPUT_PYTHON_VERSION: '3.12'
    strategy:
      fail-fast: false
      matrix:
        runner:
          - macos-latest
          - ubuntu-latest
          - windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ env.INPUT_PYTHON_VERSION }}

      - name: Set up Node
        uses: actions/setup-node@v6
        with:
          node-version: latest

      - name: Install Python Dependencies
        shell: bash
        run: |
          python -m pip install --upgrade pip setuptools wheel
          python -m pip install --upgrade \
            -r requirements.txt \
            -r requirements-dev.txt

      - name: Install Node Dependencies
        shell: bash
        run: npm install

      - name: Test with pytest
        id: pytest
        env:
          INPUT_GITHUB_TOKEN: ${{ github.actor == 'dependabot[bot]' && secrets.GH_BOT_TOKEN || secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          echo "::group::Setup Homebrew PATH"
          if [[ "${{ runner.os }}" == "Linux" ]]; then
            # https://github.com/actions/runner-images/blob/main/images/ubuntu/Ubuntu2204-Readme.md#homebrew-note
            echo "Adding Homebrew to PATH"
            eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
          fi
          echo "::endgroup::"

          echo "::group::Run Python Tests"
          python -m pytest \
            -rxXs \
            --tb=native \
            --verbose \
            --color=yes \
            --cov=actions \
            --cov-report=xml:coverage/python-coverage.xml \
            --cov-report=json:coverage/python-coverage.json \
            --junitxml=junit-python.xml \
            -o junit_family=legacy \
            tests
          echo "::endgroup::"

      - name: Test with Jest
        id: jest
        if: >-
          always() &&
          (steps.pytest.outcome == 'success' || steps.pytest.outcome == 'failure')
        env:
          FORCE_COLOR: true
        shell: bash
        run: npm test

      - name: Upload test results to Codecov
        # any except canceled or skipped
        if: >-
          always() &&
          (
            steps.pytest.outcome == 'success' ||
            steps.pytest.outcome == 'failure' ||
            steps.jest.outcome == 'success' ||
            steps.jest.outcome == 'failure'
          ) &&
          startsWith(github.repository, 'LizardByte/')
        uses: codecov/test-results-action@v1
        with:
          fail_ci_if_error: true
          files: ./junit-python.xml,./junit.xml
          flags: ${{ runner.os }}
          token: ${{ secrets.CODECOV_TOKEN }}
          verbose: true

      - name: Upload coverage to Codecov
        # any except canceled or skipped
        if: >-
          always() &&
          (
            steps.pytest.outcome == 'success' ||
            steps.pytest.outcome == 'failure' ||
            steps.jest.outcome == 'success' ||
            steps.jest.outcome == 'failure'
          ) &&
          startsWith(github.repository, 'LizardByte/')
        uses: codecov/codecov-action@v5
        with:
          fail_ci_if_error: true
          files: ./coverage/python-coverage.xml,./coverage/coverage-final.json
          flags: ${{ runner.os }}
          token: ${{ secrets.CODECOV_TOKEN }}
          verbose: true
